local revision = tonumber(string.sub("$Revision: 18625 $", 12, -3))
if revision > Cartographer.revision then
	Cartographer.version = "r" .. revision
	Cartographer.revision = revision
	Cartographer.date = string.sub("$Date: 2006-12-02 16:13:35 +0300 (Сб, 02 дек 2006) $", 8, 17)
end

-- if you want to add data to the defaults, send ckknight@gmail.com your
-- C:\Program Files\World of Warcraft\WTF\Account\ACCOUNTNAME\SavedVariables\Cartographer.lua
-- file.

local L = AceLibrary("AceLocale-2.2"):new("Cartographer-Foglight")

L:RegisterTranslations("enUS", function() return {
	["Foglight"] = true,
	["Module to show unexplored areas on the map."] = true,

	["Unexplored color"] = true,
	["Change the color of the unexplored areas"] = true,
} end)

L:RegisterTranslations("ruRU", function() return {
	["Foglight"] = "Противотуман",
	["Module to show unexplored areas on the map."] = "Модуль отображает неисследованные территории на карте.",

	["Unexplored color"] = "Цвет тумана",
	["Change the color of the unexplored areas"] = "Изменить цвет неисследованных территорий",
} end)

L:RegisterTranslations("koKR", function() return {
	["Foglight"] = "미 탐색 지역",
	["Module to show unexplored areas on the map."] = "지도에 탐험하지 못한 지역을 보여줍니다.",

	["Unexplored color"] = "색상",
	["Change the color of the unexplored areas"] = "탐험하지 못한 지역의 색상을 변경합니다.",
} end)

local math_mod = math.fmod or math.mod
local math_floor = math.floor
local math_ceil = math.ceil
local _G = getfenv(0)

Cartographer_Foglight = Cartographer:NewModule("Foglight", "AceHook-2.1", "AceEvent-2.0")

function Cartographer_Foglight:OnInitialize()
	ColorPickerFrame:SetFrameStrata("DIALOG")
	self.name = L["Foglight"]
	self.title = L["Foglight"]
    self.db = Cartographer:AcquireDBNamespace("Foglight")
    Cartographer:RegisterDefaults("Foglight", "profile", {
		darkR = 1,
		darkG = 1,
		darkB = 1,
		darkA = 1,
    })
	Cartographer:RegisterDefaults("Foglight", "account", {
		errata = {
		["Stranglethorn"] = {
			["LAKENAZFERITI"] = 63697974400,
			["VENTURECOBASECAMP"] = 69125403753,
			["MOSHOGGOGREMOUND"] = 101384895616,
			["GROMGOLBASECAMP"] = 142006658158,
			["MIZJAHRUINS"] = 140986398825,
			["BALIAMAHRUINS"] = 138901860462,
			["RUINSOFZULMAMWE"] = 228046533802,
			["THEARENA"] = 203183809736,
			["ZIATAJAIRUINS"] = 248416171136,
			["CRYSTALVEINMINE"] = 296714625144,
			["RUINSOFJUBUWAL"] = 323517266030,
			["RUINSOFABORAZ"] = 360070610015,
			["BLOODSAILCOMPOUND"] = 305146281125,
			["MISTVALEVALLEY"] = 395430720637,
			["NEKMANIWELLSPRING"] = 385694682202,
			["BOOTYBAY"] = 465143201937,
			["ZULGURUB"] = 9096622325,
			["KURZENSCOMPOUND"] = 407001243,
			["REBELCAMP"] = 297887914,
			["NESINGWARYSEXPEDITION"] = 28199467148,
			["RUINSOFZULKUNDA"] = 3426889853,
			["ZUULDAIARUINS"] = 45260852339,
			["THEVILEREEF"] = 96796327102,
			["BALALRUINS"] = 99037036634,
			["KALAIRUINS"] = 94802902111,
			["WILDSHORE"] = 453359368357,
			["JAGUEROISLE"] = 529684095101,
		},
		["Alterac"] = {
			["GROWLESSCAVE"] = 399764531390,
			["GAVINSNAZE"] = 513484700832,
			["GALLOWSCORNER"] = 299999895752,
			["DANDREDSFOLD"] = 289642781,
			["DALARAN"] = 281347928364,
			["CRUSHRIDGEHOLD"] = 174296645912,
			["CORRAHNSDAGGER"] = 408440570051,
			["CHILLWINDPOINT"] = 272313469278,
			["THEUPLANDS"] = 83162767595,
			["THEHEADLAND"] = 506061853861,
			["STRAHNBRAD"] = 113318867314,
			["SOFERASNAZE"] = 330123510015,
			["RUINSOFALTERAC"] = 211810516223,
			["MISTYSHORE"] = 140865986780,
			["LORDAMEREINTERNMENTCAMP"] = 432764364106,
		},
		["Duskwood"] = {
			["THEDARKENEDBANK"] = 33379535758,
			["MANORMISTMANTLE"] = 129533918408,
			["DARKSHIRE"] = 174608113979,
			["TRANQUILGARDENSCEMETARY"] = 379754606812,
			["THEROTTINGORCHARD"] = 396776151290,
			["BRIGHTWOODGROVE"] = 126156624092,
			["THEYORGENFARMSTEAD"] = 410578577643,
			["TWILIGHTGROVE"] = 85138510184,
			["VULGOLOGREMOUND"] = 373917250815,
			["RAVENHILLCEMETARY"] = 160076968286,
			["RAVENHILL"] = 324377134275,
			["ADDLESSTEAD"] = 367277631763,
			["THEHUSHEDBANK"] = 141754181792,
		},
		["Wetlands"] = {
			["DUNMODR"] = 22969241805,
			["IRONBEARDSTOMB"] = 123846452424,
			["SALTSPRAYGLEN"] = 44272173256,
			["SUNDOWNMARSH"] = 88143544620,
			["WHELGARSEXCAVATIONSITE"] = 220376261827,
			["BLUEGILLMARSH"] = 152564857057,
			["BLACKCHANNELMARSH"] = 263147666672,
			["MENETHILHARBOR"] = 337168695471,
			["GRIMBATOL"] = 247601668446,
			["RAPTORRIDGE"] = 189637230782,
			["DIREFORGEHILL"] = 124012194048,
			["MOSSHIDEFEN"] = 284020692173,
			["THEGREENBELT"] = 134696124601,
			["THELGANROCK"] = 398851242214,
			["ANGERFANGENCAMPMENT"] = 234439763169,
		},
		["Redridge"] = {
			["GALARDELLVALLEY"] = 173558458618,
			["STONEWATCHFALLS"] = 344221501760,
			["RENDERSVALLEY"] = 388128570833,
			["STONEWATCH"] = 231379087615,
			["ALTHERSMILL"] = 138931353835,
			["RENDERSCAMP"] = 290717971,
			["REDRIDGECANYONS"] = 77436540269,
			["LAKESHIRE"] = 211614371156,
			["LAKEEVERSTILL"] = 257837780503,
			["LAKERIDGEHIGHWAY"] = 357752408494,
			["THREECORNERS"] = 304943036781,
		},
		["Darkshore"] = {
			["AMETHARAN"] = 328904946878,
			["AUBERDINE"] = 174279842966,
			["BASHALARAN"] = 194730200244,
			["CLIFFSPRINGRIVER"] = 101325142246,
			["TOWEROFALTHALAXX"] = 91758988458,
			["RUINSOFMATHYSTRA"] = 534994115,
			["THEMASTERSGLAIVE"] = 547953473711,
			["REMTRAVELSEXCAVATION"] = 521005096111,
			["GROVEOFTHEANCIENTS"] = 442701621448,
		},
		["LochModan"] = {
			["VALLEYOFKINGS"] = 397399025859,
			["STONESPLINTERVALLEY"] = 373887890687,
			["THELSAMAR"] = 218197367040,
			["GRIZZLEPAWRIDGE"] = 333184342311,
			["IRONBANDSEXCAVATIONSITE"] = 345176801625,
			["THEFARSTRIDERLODGE"] = 214247447922,
			["NORTHGATEPASS"] = 13016281318,
			["SILVERSTREAMMINE"] = 12051560683,
			["THELOCH"] = 93785057600,
			["MOGROSHSTRONGHOLD"] = 52108176699,
			["STONEWROUGHTDAM"] = 12166806818,
		},
		["Silverpine"] = {
			["BERENSPERIL"] = 448265375984,
			["THEGREYMANEWALL"] = 480360226002,
			["PYREWOODVILLAGE"] = 479298974860,
			["SHADOWFANGKEEP"] = 385855160540,
			["AMBERMILL"] = 281838600432,
			["OLSENSFARTHING"] = 270983685285,
			["DEEPELEMMINE"] = 280739621024,
			["THESEPULCHER"] = 180757889234,
			["THEDECREPITFERRY"] = 155098211508,
			["FENRISISLE"] = 80078920954,
			["NORTHTIDESHOLLOW"] = 137777774772,
			["THESKITTERINGDARK"] = 40028509369,
			["THEDEADFIELD"] = 70214915247,
			["THESHININGSTRAND"] = 14440165632,
			["MALDENSORCHARD"] = 487751936,
		},
		["Westfall"] = {
			["THEDUSTPLAINS"] = 405349313824,
			["THEDAGGERHILLS"] = 449179729152,
			["WESTFALLLIGHTHOUSE"] = 501652584728,
			["DEMONTSPLACE"] = 402871477448,
			["ALEXSTONFARMSTEAD"] = 279386999089,
			["MOONBROOK"] = 355741147356,
			["SENTINELHILL"] = 259235496131,
			["THEDEADACRE"] = 271132639432,
			["GOLDCOASTQUARRY"] = 109752615137,
			["THEMOLSENFARM"] = 159257933025,
			["SALDEANSFARM"] = 113224403169,
			["JANGOLODEMINE"] = 31460646103,
			["FURLBROWSPUMPKINFARM"] = 12217179346,
			["THEJANSENSTEAD"] = 511910053,
		},
		["Durotar"] = {
			["ORGRIMMAR"] = 256016829,
			["SKULLROCK"] = 35920132224,
			["DRYGULCHRAVINE"] = 84199768274,
			["THUNDERRIDGE"] = 64767598782,
			["RAZORMANEGROUNDS"] = 203253061862,
			["RAZORHILL"] = 182989330652,
			["TIRAGARDEKEEP"] = 307574788286,
			["ECHOISLES"] = 459063673032,
			["KOLKARCRAG"] = 511534293152,
			["SENJINVILLAGE"] = 412814080160,
			["VALLEYOFTRIALS"] = 343969848535,
		},
		["Tirisfal"] = {
			["DEATHKNELL"] = 352425555189,
			["SOLLIDENFARMSTEAD"] = 268686225664,
			["AGAMANDMILLS"] = 149601601792,
			["STILLWATERPOND"] = 297840804026,
			["NIGHTMAREVALE"] = 375116733683,
			["COLDHEARTHMANOR"] = 351610732694,
			["BRILL"] = 321612052608,
			["GARRENSHAUNT"] = 156213932206,
			["RUINSOFLORDAERON"] = 388106530107,
			["BRIGHTWATERLAKE"] = 149865922761,
			["BALNIRFARMSTEAD"] = 350700621016,
			["CRUSADEROUTPOST"] = 311039230125,
			["SCARLETWATCHPOST"] = 112391871663,
			["MONASTARY"] = 135000159443,
			["BULWARK"] = 389426656486,
			["VENOMWEBVALE"] = 220911065325,
		},
		["Mulgore"] = {
			["WINDFURYRIDGE"] = 414318797,
			["REDROCKS"] = 17706490061,
			["WILDMANEWATERWELL"] = 305266873,
			["THUNDERBLUFF"] = 63612109080,
			["BAELDUNDIGSITE"] = 230048321746,
			["THUNDERHORNWATERWELL"] = 260243090560,
			["THEGOLDENPLAINS"] = 86348382423,
			["RAVAGEDCARAVAN"] = 279668973696,
			["THEVENTURECOMINE"] = 256108637409,
			["THEROLLINGPLAINS"] = 382800689408,
			["WINTERHOOFWATERWELL"] = 396691112106,
			["BLOODHOOFVILLAGE"] = 325728805120,
			["PALEMANEROCK"] = 329956668544,
			["REDCLOUDMESA"] = 456623640022,
		},
		["DunMorogh"] = {
			["ANVILMAR"] = 432880674032,
			["COLDRIDGEPASS"] = 413700063382,
			["CHILLBREEZEVALLEY"] = 318115020980,
			["SHIMMERRIDGE"] = 175383967872,
			["THEGRIZZLEDDEN"] = 334263149768,
			["KHARANOS"] = 316085051592,
			["MISTYPINEREFUGE"] = 237823497344,
			["THETUNDRIDHILLS"] = 346292355227,
			["AMBERSTILLRANCH"] = 301248675968,
			["HELMSBEDLAKE"] = 293859403931,
			["GOLBOLARQUARRY"] = 313096574117,
			["SOUTHERNGATEOUTPOST"] = 300404564096,
			["NORTHERNGATEOUTPOST"] = 186553373824,
			["FROSTMANEHOLD"] = 308391572605,
			["BREWNALLVILLAGE"] = 267626073203,
			["ICEFLOWLAKE"] = 179609718912,
			["GNOMERAGON"] = 197742728372,
			["IRONFORGE"] = 175436407099,
		},
		["Elwynn"] = {
			["STONECAIRNLAKE"] = 204626723126,
			["CRYSTALLAKE"] = 356925010145,
			["RIDGEPOINTTOWER"] = 467807741234,
			["EASTVALELOGGINGCAMP"] = 355073214720,
			["BRACKWELLPUMPKINPATCH"] = 450503107840,
			["TOWEROFAZORA"] = 314110634239,
			["JERODSLANDING"] = 463228613888,
			["NORTHSHIREVALLEY"] = 158239817984,
			["FARGODEEPMINE"] = 459811307776,
			["FORESTSEDGE"] = 351243949312,
			["GOLDSHIRE"] = 290172662000,
			["STORMWIND"] = 415205,
		},
		["Teldrassil"] = {
			["WELLSPRINGLAKE"] = 100253565108,
			["THEORACLEGLADE"] = 136650670250,
			["STARBREEZEVILLAGE"] = 314121068744,
			["SHADOWGLEN"] = 164797580513,
			["RUTTHERANVILLAGE"] = 588928618624,
			["POOLSOFARLITHRIEN"] = 336432658560,
			["LAKEALAMETH"] = 408479261952,
			["GNARLPINEHOLD"] = 476053635257,
			["DOLANAAR"] = 347303182526,
			["DARNASSUS"] = 265320399163,
			["BANETHILHOLLOW"] = 302122223776,
		},
		["Balor"] = {
			["CROAKINGPLATEAU"] = 268960256,
			["RUINSOFBREEZEHAVEN"] = 275146605056,
			["SIOUTPOST"] = 275415302400,
			["BILGERATCOMPOUND"] = 268697856,
			["GULLWINGWRECKAGE"] = 262656,
			["STORMBREAKERPOINT"] = 537395712,
			["GRAHANESTATE"] = 275146604800,
			["VANDERFARMSTEAD"] = 275146604800,
			["TREACHEROUSCRAGS"] = 275146867200,
			["WINDROCKCLIFFS"] = 275146866944,
			["STORMREAVERSPIRE"] = 275146867200,
			["STORMWROUGHTCASTLE"] = 275146605056,
			["SCURRYINGTHICKET"] = 268960000,
			["SORROWMORELAKE"] = 275146604800,
			["LANGSTONORCHARD"] = 275146604800,
		},
		["Northwind"] = {
			["BRISTLEWHISKERCAVERN"] = 537395456,
			["SHERWOODQUARRY"] = 537395712,
			["ABBEYGARDENS"] = 537133312,
			["RUINSOFBIRKHAVEN"] = 537395712,
			["BLACKROCKBREACH"] = 537395712,
			["CINDERFALLPASS"] = 275415302656,
			["GRIMMENLAKE"] = 275415302400,
			["CRAWFORDWINERY"] = 275415040256,
			["NORTHRIDGEPOINT"] = 268960256,
			["WITCHCOVEN"] = 268697856,
			["NORTHWINDLOGGINGCAMP"] = 268960000,
			["AMBERWOODKEEP"] = 274878169600,
			["TOWEROFMAGILOU"] = 524800,
			["STILLHEARTPORT"] = 524800,
			["CRYSTALFALLS"] = 275415302656,
			["AMBERSHIRE"] = 275146605056,
			["MERCHANTSHIGHROAD"] = 275146867200,
		},
		["Lapidis"] = {
			["THEROCK"] = 537133312,
			["SHANKSREEF"] = 268698112,
			["HAZURRIGLADE"] = 275146605056,
			["GORDOSHHEIGHTS"] = 268960000,
			["CROWNISLAND"] = 537133312,
			["CAELANSREST"] = 537395456,
			["BRIGHTCOAST"] = 525056,
			["ZULHAZU"] = 275146867200,
			["WALLOWINGCOAST"] = 275146605056,
			["TOWEROFLAPIDIS"] = 268960256,
		},
		["Icepoint"] = {
			["KANEQNUUN"] = 787456,
		},
		["Ashenvale"] = {
			["THERUINSOFSTARDUST"] = 400778483867,
			["IRISLAKE"] = 234486969544,
			["ASTRANAAR"] = 269794600141,
			["FIRESCARSHRINE"] = 348090711205,
			["THESHRINEOFAESSINA"] = 278208384220,
			["THISTLEFURVILLAGE"] = 169864269055,
			["MAESTRASPOST"] = 41017459927,
			["LAKEFALATHIM"] = 147240193152,
			["THEZORAMSTRAND"] = 30084945141,
			["FELFIREHILL"] = 370115083509,
			["WARSONGLUMBERCAMP"] = 334768537800,
			["BOUGHSHADOW"] = 163032801426,
			["SATYRNAAR"] = 242319811869,
			["NIGHTRUN"] = 277651651809,
			["FALLENSKYLAKE"] = 457987798251,
			["RAYNEWOODRETREAT"] = 256096064692,
			["THEHOWLINGVALE"] = 151883277522,
			["MYSTRALLAKE"] = 372961952019,
		},
		["SearingGorge"] = {
			["DUSTFIREVALLEY"] = 9032807884,
			["GRIMSILTDIGSITE"] = 322640769329,
			["TANNERCAMP"] = 437584632113,
			["THESEAOFCINDERS"] = 416871113064,
			["BLACKCHARCAVE"] = 393070488851,
			["THECAULDRON"] = 182798587305,
			["FIREWATCHRIDGE"] = 32301824405,
		},
		["Arathi"] = {
			["HAMMERFALL"] = 129536092365,
			["CIRCLEOFEASTBINDING"] = 120844425376,
			["DABYRIESFARMSTEAD"] = 177662544052,
			["GOSHEKFARM"] = 296909737190,
			["WITHERBARKVILLAGE"] = 358142396631,
			["CIRCLEOFOUTERBINDING"] = 315045866666,
			["REFUGEPOINT"] = 200104182959,
			["BOULDERFISTHALL"] = 389147765975,
			["THANDOLSPAN"] = 442754101448,
			["CIRCLEOFINNERBINDING"] = 333160047826,
			["FALDIRSCOVE"] = 455446060288,
			["STROMGARDEKEEP"] = 308277385456,
			["THORADINSWALL"] = 148267843774,
			["BOULDERGOR"] = 155936085237,
			["NORTHFOLDMANOR"] = 96838336742,
			["CIRCLEOFWESTBINDING"] = 58126977214,
		},
		["Barrens"] = {
			["RAPTORGROUNDS"] = 316211837043,
			["NORTHWATCHFOLD"] = 330191462550,
			["THEMERCHANTCOAST"] = 265823555679,
			["RATCHET"] = 203520341117,
			["THESTAGNANTOASIS"] = 227064021147,
			["THECROSSROADS"] = 127153630363,
			["THORNHILL"] = 128297599116,
			["FARWATCHPOST"] = 56426140772,
			["GROLDOMFARM"] = 68161752189,
			["HONORSSTAND"] = 139907432576,
			["THEFORGOTTENPOOLS"] = 123883091064,
			["THEDRYHILLS"] = 31471060168,
			["DREADMISTPEAK"] = 68085195904,
			["THEMORSHANRAMPART"] = 432115840,
			["THESLUDGEFEN"] = 478273706,
			["BOULDERLODEMINE"] = 582072440,
			["RAZORFENKRAUL"] = 576957055104,
			["BAELMODAN"] = 514774401152,
			["BLACKTHORNRIDGE"] = 496420126875,
			["FIELDOFGIANTS"] = 432016611538,
			["CAMPTAURAJO"] = 376192496785,
			["BRAMBLESCAR"] = 320438703229,
			["AGAMAGOR"] = 251612292296,
			["LUSHWATEROASIS"] = 190435222703,
			["RAZORFENDOWNS"] = 594206117019,
		},
		["Hilsbrad"] = {
			["WESTERNSTRAND"] = 395355254045,
			["HILLSBRADFIELDS"] = 166637882673,
			["SOUTHSHORE"] = 216260688107,
			["EASTERNSTRAND"] = 364548260070,
			["NETHANDERSTEAD"] = 253970596055,
			["DUNGAROK"] = 316348321008,
			["DURNHOLDEKEEP"] = 81165399424,
			["TARRENMILL"] = 534042844,
			["DARROWHILL"] = 165790510285,
			["PURGATIONISLE"] = 517657956477,
			["SOUTHPOINTTOWER"] = 206160758048,
			["AZURELOADMINE"] = 295462707365,
		},
		["Gillijim"] = {
			["SILVERCOAST"] = 275146867200,
			["SILVERSANDBAR"] = 275146866944,
			["FAELONSFOLLY"] = 275146604800,
			["KALKORPOINT"] = 268960256,
			["ZULRAZAR"] = 275146604800,
			["JADEMINE"] = 275146605056,
			["TANGLEWOOD"] = 275415040256,
			["GILLIJIMSTRAND"] = 537395456,
			["MAULOGGREFUGE"] = 275415302656,
			["DEEPTIDESANCTUM"] = 549756076544,
			["DISTILLERYISLE"] = 524800,
			["SOUTHSEASANDBAR"] = 262656,
			["KAZONISLAND"] = 268698112,
			["MAULOGGPOST"] = 275415302400,
			["RUINSOFZULRAZAR"] = 275146867200,
		},
		["Desolace"] = {
			["KODOGRAVEYARD"] = 262399060243,
			["SHADOWPREYVILLAGE"] = 417860917478,
			["GELKISVILLAGE"] = 457721497795,
			["MANNOROCCOVEN"] = 408440561949,
			["MAGRAMVILLAGE"] = 392534717645,
			["SHADOWBREAKRAVINE"] = 477465087181,
			["RANAZJARISLE"] = 6695260260,
			["SARGERON"] = 36089091357,
			["THUNDERAXEFORTRESS"] = 109990604990,
			["KORMEKSHUT"] = 194929393834,
			["KOLKARVILLAGE"] = 231491203292,
			["ETHELRETHOR"] = 65824614605,
			["VALLEYOFSPEARS"] = 231077082357,
			["TETHRISARAN"] = 452084941,
			["NIJELSPOINT"] = 581167304,
		},
		["SwampOfSorrows"] = {
			["MISTYREEDSTRAND"] = 782921984,
			["FALLOWSANCTUARY"] = 516212077,
			["SORROWMURK"] = 129608561879,
			["STAGALBOG"] = 406453479769,
			["POOLOFTEARS"] = 234668444972,
			["STONARD"] = 254769687912,
			["THESHIFTINGMIRE"] = 118411734331,
			["SPLINTERSPEARJUNCTION"] = 253538582803,
			["THEHARBORAGE"] = 155872081131,
			["MISTYVALLEY"] = 150324167925,
			["ITHARIUSSCAVE"] = 281320609008,
		},
		["BlackstoneIsland"] = {
			["THEWATERHOLE"] = 268960256,
			["VENTURECOSLUMS"] = 268960256,
			["RUSTGATELUMBERYARD"] = 537395456,
			["BLACKASHMINE"] = 268960256,
			["BLACKASHCOALPITS"] = 786944,
			["RUSTGATERIDGE"] = 275146867200,
			["GAZZIKSWORKSHOP"] = 275146867200,
		},
		["ThalassianHighlands"] = {
			["FELSTRIDERRETREAT"] = 274878431744,
			["BRINTHILIEN"] = 275146867200,
			["SILVERSUNMINE"] = 275146866944,
			["THELASTRUNESTONE"] = 275146867200,
			["ANASTERIANPARK"] = 268960256,
			["THEFARSTRIDE"] = 524800,
			["ISLEOFETERNALAUTUMN"] = 524800,
			["RUINSOFNASHALARAN"] = 524800,
			["ALAHTHALAS"] = 268960512,
		},
		["EasternPlaguelands"] = {
			["QUELLITHIENLODGE"] = 39097358566,
			["TERRORDALE"] = 105309746366,
			["PLAGUEWOOD"] = 89298057576,
			["STRATHOLME"] = 9867305200,
			["THONDRORILRIVER"] = 248042070236,
			["THEMARRISSTEAD"] = 386710844616,
			["THEUNDERCROFT"] = 512355358905,
			["CROWNGUARDTOWER"] = 430875776205,
			["THEFUNGALVALE"] = 280530995410,
			["DARROWSHIRE"] = 525383945426,
			["THEINFECTISSCAR"] = 313109269699,
			["CORINSCROSSING"] = 394626498725,
			["LAKEMERELDAR"] = 497705729274,
			["TYRSHAND"] = 506484402421,
			["LIGHTSHOPECHAPEL"] = 321799836847,
			["PESTILENTSCAR"] = 370870053069,
			["THENOXIOUSGLADE"] = 178998435041,
			["EASTWALLTOWER"] = 259392700596,
			["BLACKWOODLAKE"] = 214138334438,
			["NORTHDALE"] = 138089280702,
			["ZULMASHAR"] = 32856249549,
			["NORTHPASSTOWER"] = 117517257968,
		},
		["Felwood"] = {
			["MORLOSARAN"] = 547054845073,
			["DEADWOODVILLAGE"] = 572732349615,
			["EMERALDSANCTUARY"] = 461060079801,
			["JADEFIREGLEN"] = 499638234277,
			["RUINSOFCONSTELLAS"] = 409407220971,
			["JAEDENAR"] = 355692839157,
			["BLOODVENOMFALLS"] = 282700432619,
			["SHATTERSCARVALE"] = 132392362219,
			["JADEFIRERUN"] = 31484717251,
			["IRONTREEWOODS"] = 58422680791,
			["TALONBRANCHGLADE"] = 97211532448,
			["FELPAWVILLAGE"] = 506610928,
		},
		["UngoroCrater"] = {
			["TERRORRUN"] = 395302958425,
			["GOLAKKAHOTSPRINGS"] = 162262246715,
			["FIREPLUMERIDGE"] = 191511148839,
			["LAKKARITARPITS"] = 6610495034,
			["IRONSTONEPLATEAU"] = 72551265565,
			["THEMARSHLANDS"] = 258285604150,
			["THESLITHERINGSCAR"] = 408407012697,
		},
		["Hinterlands"] = {
			["THEOVERLOOKCLIFFS"] = 326070753450,
			["JINTHAALOR"] = 358085850347,
			["SHAOLWATHA"] = 257223243032,
			["SKULKROCK"] = 249645122720,
			["SERADANE"] = 20935101715,
			["THEALTAROFZUL"] = 392307053768,
			["THECREEPINGRUIN"] = 279600867508,
			["AGOLWATHA"] = 176486026445,
			["VALORWINDLAKE"] = 324604700842,
			["SHADRAALOR"] = 415789933763,
			["QUELDANILLODGE"] = 198890949817,
			["HIRIWATHA"] = 328744509665,
			["PLAGUEMISTRAVINE"] = 160153432209,
			["AERIEPEAK"] = 263080588543,
		},
		["Badlands"] = {
			["CAMPKOSH"] = 52117598428,
			["THEMAKERSTERRACE"] = 7924298997,
			["HAMMERTOESDIGSITE"] = 129315835080,
			["DUSTWINDGULCH"] = 224934442229,
			["ANGORFORTRESS"] = 159254782147,
			["VALLEYOFFANGS"] = 275244095718,
			["THEDUSTBOWL"] = 213841628430,
			["KARGATH"] = 158914051312,
			["APOCRYPHANSREST"] = 332878001407,
			["CAMPCAGG"] = 459574309119,
			["MIRAGEFLATS"] = 412472295709,
			["AGMONDSEND"] = 418047605001,
			["CAMPBOFF"] = 366671585535,
			["LETHLORRAVINE"] = 118752746866,
		},
		["StonetalonMountains"] = {
			["BRAMBLETHORNPASS"] = 275415302656,
			["BAELHARDUL"] = 275415040512,
			["THEEARTHENRING"] = 275146605056,
			["AMANIALOR"] = 262656,
			["BLACKSANDOILFIELDS"] = 524800,
			["POWDERTOWN"] = 275146604800,
			["VENTURECOMPANYCAMP"] = 268960000,
			["BROKENCLIFFMINE"] = 268960000,
			["CAMPAPARAJE"] = 550292947456,
			["GRIMTOTEMPOST"] = 550292947456,
			["MALAKAJIN"] = 550292947456,
			["WEBWINDERPATH"] = 275415302400,
			["BOULDERSLIDERAVINE"] = 550292947200,
			["SISHIRCANYON"] = 275415302400,
			["WINDSHEARCRAG"] = 275415040256,
			["SUNROCKRETREAT"] = 275146605056,
			["THECHARREDVALE"] = 275146866944,
			["MIRKFALLONLAKE"] = 268960256,
			["STONETALONPEAK"] = 268697856,
		},
		["UpperKarazhan2f"] = {
			["OUTLAND"] = 787456,
		},
		["TelAbim"] = {
			["THEJAGGEDISLES"] = 268960256,
			["HIGHVALERISE"] = 268960256,
			["BIXXLESSTOREHOUSE"] = 268960256,
			["THEDERELICTCAMP"] = 275146605056,
			["TAZZOSSHACK"] = 275146867200,
			["TELCOBASECAMP"] = 275146867200,
		},
		["Feralas"] = {
			["RUINSOFRAVENWIND"] = 319974590,
			["ONEIROS"] = 75678988398,
			["DREAMBOUGH"] = 476181654,
			["CAMPMOJACHE"] = 250904477851,
			["THEWRITHINGDEEP"] = 320623309040,
			["RUINSOFISILDIEN"] = 344163870910,
			["FRAYFEATHERHIGHLANDS"] = 414965737582,
			["FERALSCARVALE"] = 353770785907,
			["DIREMAUL"] = 216298360038,
			["THEFORGOTTENCOAST"] = 275301859473,
			["THETWINCOLOSSALS"] = 80865383709,
			["LOWERWILDS"] = 213388546273,
			["ISLEOFDREAD"] = 402854810839,
			["SARDORISLE"] = 251473875124,
			["GORDUNNIOUTPOST"] = 152121283724,
			["GRIMTOTEMCOMPOUND"] = 179968347256,
		},
		["WesternPlaguelands"] = {
			["THONDRORILRIVER"] = 92960805069,
			["THEWEEPINGCAVE"] = 213194580128,
			["GAHRRONSWITHERING"] = 268980925620,
			["HEARTHGLEN"] = 17502077268,
			["NORTHRIDGELUMBERCAMP"] = 176494399708,
			["THEWRITHINGHAUNT"] = 347291711658,
			["DALSONSTEARS"] = 284941244636,
			["FELSTONEFIELD"] = 334248408224,
			["THEBULWARK"] = 314750199009,
			["RUINSOFANDORHOL"] = 381451213085,
			["SORROWHILL"] = 496441178412,
			["CAERDARROW"] = 443010946218,
			["DARROWMERELAKE"] = 368822204786,
		},
		["Aszhara"] = {
			["VALORMOK"] = 245975137495,
			["TIMBERMAWHOLD"] = 114079054059,
			["URSOLAN"] = 102448192657,
			["THALASSIANBASECAMP"] = 128298675440,
			["LEGASHENCAMPMENT"] = 47746003179,
			["TEMPLEOFARKKORAN"] = 164996784318,
			["TOWEROFELDARA"] = 115748269176,
			["BITTERREACHES"] = 43625145589,
			["JAGGEDREEF"] = 383953466,
			["THESHATTEREDSTRAND"] = 208729753760,
			["BAYOFSTORMS"] = 216324681998,
			["FORLORNRIDGE"] = 396411272412,
			["THERUINEDREACHES"] = 580235952523,
			["LAKEMENNAR"] = 460945826107,
			["RAVENCRESTMONUMENT"] = 536376112368,
			["SOUTHRIDGEBEACH"] = 379438985586,
			["RUINSOFELDARATH"] = 237546791177,
			["SHADOWSONGSHRINE"] = 453155934433,
			["HALDARRENCAMPMENT"] = 355489437896,
		},
		["BlastedLands"] = {
			["RISEOFTHEDEFILER"] = 132495066282,
			["THETAINTEDSCAR"] = 191348803968,
			["DREADMAULPOST"] = 209758391541,
			["ALTAROFSTORMS"] = 143132880057,
			["DARKPORTAL"] = 278574362889,
			["SERPENTSCOIL"] = 150849366241,
			["NETHERGARDEKEEP"] = 32798603449,
			["GARRISONARMORY"] = 10158809258,
			["DREADMAULHOLD"] = 16484847811,
		},
		["BurningSteppes"] = {
			["ALTAROFSTORMS"] = 117075833057,
			["DRACODAR"] = 277084433823,
			["BLACKROCKSTRONGHOLD"] = 122757063925,
			["PILLAROFASH"] = 306412009792,
			["RUINSOFTHAURISSAN"] = 106838652174,
			["BLACKROCKPASS"] = 300191897870,
			["TERRORWINGPATH"] = 50149559576,
			["MORGANSVIGIL"] = 334676375846,
			["DREADMAULROCK"] = 181130200284,
			["BLACKROCKMOUNTAIN"] = 108629614848,
		},
		["GrimReaches"] = {
			["ZARMGETHPOINT"] = 268698112,
			["ZARMGETHSTRONGHOLD"] = 268698112,
			["GETHKAR"] = 268698112,
			["RUINSOFSTOLGAZKEEP"] = 268697856,
			["BARLEYCRESTFARMSTEAD"] = 268960256,
			["BAGGOTHSRAMPART"] = 268960000,
			["THEHIGHPASS"] = 275146604800,
			["DUNKITHAS"] = 275146605056,
			["LAKEKITHAS"] = 275146605056,
			["SALGAZMINES"] = 275415040256,
			["SLATEBEARDSFORGE"] = 275146605056,
			["THEGRIMHOLLOW"] = 275146867200,
			["EASTRIDGEOUTPOST"] = 268960256,
			["BRANGARSFOLLY"] = 537133312,
			["SHATTERBLADEPOST"] = 537133312,
			["GROLDANSEXCAVATION"] = 537395456,
		},
		["Hyjal"] = {
			["NORDANAAR"] = 805830912,
			["NORDRASSILGLADE"] = 537395712,
			["BLEAKHOLLOWCRATER"] = 268960256,
			["BARKSKINPLATEAU"] = 275146605056,
			["CIRCLEOFPOWER"] = 524800,
			["RUINSOFTELENNAS"] = 524800,
			["ZULHATHA"] = 524544,
			["THEEMERALDGATEWAY"] = 274878431744,
			["DARKHOLLOWPASS"] = 275146867200,
			["BARKSKINVILLAGE"] = 275146867456,
		},
		["Moonglade"] = {
			["LAKEELUNEARA"] = 95819397675,
		},
		["ThousandNeedles"] = {
			["HIGHPERCH"] = 166462683326,
			["CAMPETHOK"] = 317745,
			["THEGREATLIFT"] = 75377070290,
			["DARKCLOUDPINNACLE"] = 140931960013,
			["THESCREECHINGCANYON"] = 214936305914,
			["FREEWINDPOST"] = 283842377938,
			["SPLITHOOFCRAG"] = 206568623314,
			["WINDBREAKCANYON"] = 268951580912,
			["THESHIMMERINGFLATS"] = 322762552640,
		},
		["Dustwallow"] = {
			["ALCAZISLAND"] = 23240838344,
			["THEWYRMBOG"] = 409480708381,
			["THEDENOFFLAME"] = 336350931199,
			["BACKBAYWETLANDS"] = 203188075920,
			["BRACKENWALLVILLAGE"] = 241449240,
			["WITCHHILL"] = 442821882,
			["THERAMOREISLE"] = 241078318310,
		},
		["Tanaris"] = {
			["ZULFARRAK"] = 266517714,
			["SANDSORROWWATCH"] = 107687886019,
			["THEGAPINGCHASM"] = 399902984412,
			["EASTMOONRUINS"] = 371929012384,
			["LANDSENDBEACH"] = 549148849357,
			["SOUTHMOONRUINS"] = 385812220099,
			["VALLEYOFTHEWATCHERS"] = 466309251222,
			["THISTLESHRUBVALLEY"] = 307303278777,
			["GADGETZAN"] = 98152125615,
			["CAVERNSOFTIME"] = 275466311835,
			["NOONSHADERUINS"] = 112228179064,
			["STEAMWHEEDLEPORT"] = 81151547547,
			["ZALASHJISDEN"] = 158480871534,
			["LOSTRIGGERCOVE"] = 236882950304,
			["WATERSPRINGFIELD"] = 180922536101,
			["ABYSSALSANDS"] = 208686731479,
			["BROKENPILLAR"] = 251751747694,
			["THENOXIOUSLAIR"] = 213939069108,
			["DUNEMAULCOMPOUND"] = 310652323021,
			["SOUTHBREAKSHORE"] = 315129773271,
		},
		["Gilneas"] = {
			["RAVENWOODKEEP"] = 275146867200,
			["RAVENSHIRE"] = 275146867200,
			["THEOVERGROWNACRE"] = 275146605056,
			["SOUTHMIREORCHARD"] = 275146604800,
			["BROLOKMOUND"] = 275146605056,
			["FREYSHEARKEEP"] = 275415040256,
			["GREYMANESWATCH"] = 275415040256,
			["GLAYMORESTEAD"] = 268698112,
			["STILLWARDCHURCH"] = 268960256,
			["NORTHGATETOWER"] = 268960256,
			["DAWNSTONEMINE"] = 268960000,
			["ROSEWICKPLANTATION"] = 268960000,
			["OLDROCKPASS"] = 268697856,
			["THEGREYMANEWALL"] = 268698112,
			["GILNEASCITY"] = 524800,
			["BLACKTHORNSCAMP"] = 524544,
			["THEDRYROCKMINE"] = 274878169600,
			["THEDRYROCKPIT"] = 274878169600,
			["SHADEMORETAVERN"] = 275146604800,
			["RUINSOFGREYSHIRE"] = 274878169600,
			["HOLLOWWEBCEMETARY"] = 274878431744,
			["HOLLOWWEBWOODS"] = 275146866944,
		},
		["AlteracValley"] = {
			["FROSTWOLFKEEP"] = 403071863019,
			["ICEBLOODGARRISON"] = 185035174188,
			["DUNBALDAR"] = 14323794190,
		},
		["DeadwindPass"] = {
			["KARAZHAN"] = 362133312812,
			["THEVICE"] = 321495775502,
			["DEADMANSCROSSING"] = 81865848188,
		},
		["Silithus"] = {
			["THESCARABWALL"] = 443577270560,
			["HIVEREGAL"] = 306273714688,
			["HIVEZORA"] = 154721059200,
			["TWILIGHTBASECAMP"] = 211888111936,
			["SOUTHWINDVILLAGE"] = 70317900160,
			["HIVEASHI"] = 13163102720,
			["THECRYSTALVALE"] = 25879151936,
		},
		["Winterspring"] = {
			["FROSTSABERROCK"] = 7902253306,
			["THEHIDDENGROVE"] = 29573178543,
			["WINTERFALLVILLAGE"] = 170298307729,
			["EVERLOOK"] = 115424305317,
			["ICETHISTLEHILLS"] = 260486370429,
			["OWLWINGTHICKET"] = 365694169253,
			["DARKWHISPERGORGE"] = 473989068031,
			["FROSTWHISPERGORGE"] = 404275495112,
			["MAZTHORIL"] = 277542523065,
			["STARFALLVILLAGE"] = 147513835705,
			["LAKEKELTHERIL"] = 213021549783,
			["TIMBERMAWPOST"] = 261159510246,
			["FROSTFIREHOTSPRINGS"] = 184916521200,
		},

			['*'] = {}
		}
	})

	Cartographer.options.args.Foglight = {
		name = L["Foglight"],
		desc = L["Module to show unexplored areas on the map."],
		type = 'group',
		args = {
			color = {
				name = L["Unexplored color"],
				desc = L["Change the color of the unexplored areas"],
				type = "color",
				get = "GetDarkColor",
				set = "SetDarkColor",
				hasAlpha = true,
			},
			toggle = {
				name = AceLibrary("AceLocale-2.2"):new("Cartographer")["Active"],
				desc = AceLibrary("AceLocale-2.2"):new("Cartographer")["Suspend/resume this module."],
				type = "toggle",
				order = -1,
				get = function() return Cartographer:IsModuleActive(self) end,
				set = function() Cartographer:ToggleModuleActive(self) end
			},
		},
		handler = self,
	}
end

function Cartographer_Foglight:OnEnable()
	self.overlayInfo = self.db.account.errata
	self:Hook("GetNumMapOverlays", true)
	self:Hook("WorldMapFrame_Update", true)
	if WorldMapFrame:IsShown() then
		WorldMapFrame_Update()
	end
end

function Cartographer_Foglight:OnDisable()
	for i = 1, NUM_WORLDMAP_OVERLAYS do
		local texture = _G["WorldMapOverlay"..i]
		texture:Hide()
		texture:SetVertexColor(1.0,1.0,1.0)
		texture:SetAlpha(1.0)
	end
	if WorldMapFrame:IsShown() then
		WorldMapFrame_Update()
	end
end

function Cartographer_Foglight:GetNumMapOverlays()
	if NUM_WORLDMAP_OVERLAYS == 0 then
		return self.hooks.GetNumMapOverlays()
	end
	return 0
end

function Cartographer_Foglight:WorldMapFrame_Update()
	self.hooks.WorldMapFrame_Update()
	self:WorldMapFrame_UpdateOverlays()
end

local discovered = {}
function Cartographer_Foglight:WorldMapFrame_UpdateOverlays()
	if not WorldMapFrame:IsShown() then
		return
	end

	local mapFileName, textureHeight = GetMapInfo()
	if not mapFileName then
		return
	end

	local prefix = "Interface\\WorldMap\\"..mapFileName.."\\"
	local zoneTable = self.overlayInfo[mapFileName]

	local numOverlays = self.hooks.GetNumMapOverlays()
	local len = string.len(prefix)+1
	for i=1, numOverlays do
		local tname,tw,th,ofx,ofy = GetMapOverlayInfo(i)
		tname = string.sub(tname, len)
		local num = tw + th * 1024 + ofx * 1048576 + ofy * 1073741824
		discovered[tname] = num
		zoneTable[tname] = num
	end

	local textureCount = 0

	for tname, num in pairs(zoneTable) do
		local textureName = prefix .. tname
		local textureWidth, textureHeight, offsetX, offsetY = math_mod(num, 1024), math_mod(math_floor(num / 1024), 1024), math_mod(math_floor(num / 1048576), 1024), math_floor(num / 1073741824)

		-- HACK: override *known incorrect* data with hard-coded fixes.
		if textureName == "Interface\\WorldMap\\Tirisfal\\BRIGHTWATERLAKE" then
			if offsetX == 587 then
				offsetX = 584
			end
		end
		if textureName == "Interface\\WorldMap\\Silverpine\\BERENSPERIL" then
			if offsetY == 417 then
				offsetY = 415
			end
		end

		local numTexturesWide = math_ceil(textureWidth / 256)
		local numTexturesTall = math_ceil(textureHeight / 256)
		local neededTextures = textureCount + numTexturesWide*numTexturesTall
		if neededTextures > NUM_WORLDMAP_OVERLAYS then
			for j = NUM_WORLDMAP_OVERLAYS+1, neededTextures do
				WorldMapDetailFrame:CreateTexture("WorldMapOverlay"..j, "ARTWORK")
			end
			NUM_WORLDMAP_OVERLAYS = neededTextures
		end
		for j = 1, numTexturesTall do
			local texturePixelHeight
			local textureFileHeight
			if j < numTexturesTall then
				texturePixelHeight = 256
				textureFileHeight = 256
			else
				texturePixelHeight = math_mod(textureHeight, 256)
				if texturePixelHeight == 0 then
					texturePixelHeight = 256
				end
				textureFileHeight = 16
				while textureFileHeight < texturePixelHeight do
					textureFileHeight = textureFileHeight * 2
				end
			end
			for k = 1, numTexturesWide do
				if textureCount > NUM_WORLDMAP_OVERLAYS then
					return
				end
				textureCount = textureCount + 1
				local texture = _G["WorldMapOverlay"..textureCount]
				if k < numTexturesWide then
					texturePixelWidth = 256
					textureFileWidth = 256
				else
					texturePixelWidth = math_mod(textureWidth, 256)
					if texturePixelWidth == 0 then
						texturePixelWidth = 256
					end
					textureFileWidth = 16
					while textureFileWidth < texturePixelWidth do
						textureFileWidth = textureFileWidth * 2
					end
				end
				texture:SetWidth(texturePixelWidth)
				texture:SetHeight(texturePixelHeight)
				texture:SetTexCoord(0, texturePixelWidth/textureFileWidth, 0, texturePixelHeight/textureFileHeight)
				texture:ClearAllPoints()
				texture:SetPoint("TOPLEFT", "WorldMapDetailFrame", "TOPLEFT", offsetX + (256 * (k-1)), -(offsetY + (256 * (j - 1))))
				texture:SetTexture(textureName..(((j - 1) * numTexturesWide) + k))

				if discovered[tname] then
					texture:SetVertexColor(1.0,1.0,1.0)
					texture:SetAlpha(1.0)
				else
					texture:SetVertexColor(self.db.profile.darkR, self.db.profile.darkG, self.db.profile.darkB)
					texture:SetAlpha(self.db.profile.darkA)
				end
				texture:Show()
			end
		end
	end
	for i = textureCount+1, NUM_WORLDMAP_OVERLAYS do
		_G["WorldMapOverlay"..i]:Hide()
	end
	for k in pairs(discovered) do
		discovered[k] = nil
	end
end


function Cartographer_Foglight:GetDarkColor()
	return self.db.profile.darkR, self.db.profile.darkG, self.db.profile.darkB, self.db.profile.darkA
end

function Cartographer_Foglight:SetDarkColor(r,g,b,a)
	if WorldMapFrame:IsShown() and WorldMapFrame:GetFrameStrata() == "FULLSCREEN" then
		ToggleWorldMap()
	end
	self.db.profile.darkR, self.db.profile.darkG, self.db.profile.darkB, self.db.profile.darkA = r,g,b,a
	self:WorldMapFrame_UpdateOverlays()
end

function Cartographer_Foglight:OnProfileEnable()
	WorldMapFrame_Update()
end
